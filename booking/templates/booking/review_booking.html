{% extends "booking/base.html" %}
{% block content %}

<div class="card review-card">

    <h2 class="review-title">Review Booking</h2>

    <div class="review-grid">
        <div class="review-left">
            <p><strong>Hotel:</strong> {{ hotel.name }}</p>
            <p><strong>Room:</strong> {{ plan.room_type.name }}</p>
            <p><strong>Plan:</strong> {{ plan.get_plan_type_display }}</p>

            <hr>

            <p><strong>Check-in:</strong> {{ check_in }}</p>
            <p><strong>Check-out:</strong> {{ check_out }}</p>
            <p><strong>Nights:</strong> {{ nights }}</p>

            {% if coupons %}
                <hr>
                <h4>Available Coupons</h4>
                <div class="coupons-list">
                {% for c in coupons %}
                    <div class="coupon-item">
                        <strong>{{ c.code }}</strong>
                        <span class="muted">
                        {% if c.discount_type == "PERCENT" %}
                            – {{ c.discount_value }}% OFF
                        {% else %}
                            – ₹{{ c.discount_value }} OFF
                        {% endif %}
                        </span>
                    </div>
                {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="review-right">
            <div class="price-breakdown card">
                <div class="row"><span>Base Fare</span><span>₹ {{ base_fare }}</span></div>
                <div class="row"><span>GST (18%)</span><span>₹ {{ gst }}</span></div>
                <div class="row total"><span>Total Payable</span><span>₹ {{ total }}</span></div>
            </div>

            <form method="post" action="{% url 'create_booking' %}" class="booking-form">
                {% csrf_token %}
                <input type="hidden" name="plan_id" value="{{ plan.id }}">
                <input type="hidden" name="check_in" value="{{ check_in }}">
                <input type="hidden" name="check_out" value="{{ check_out }}">
                <input type="hidden" name="total" value="{{ total }}">

                <label class="field"><input name="guest_name" placeholder="Full Name *" required></label>
                <label class="field"><input name="email" placeholder="Email *" required></label>
                <label class="field"><input name="phone" placeholder="Mobile Number *" required></label>

                <div class="coupon-action">
                    <input id="coupon_input" name="coupon_code" placeholder="Coupon Code (optional)">
                    <button type="button" id="apply_coupon" class="btn-small">Apply</button>
                    <div id="coupon_spinner" class="spinner" aria-hidden="true" style="display:none;margin-left:8px"></div>
                    <div id="coupon_message" class="muted" style="margin-top:8px"></div>
                    <div id="applied_coupon" style="margin-top:10px;display:none">
                        <span class="badge applied">Applied <strong id="applied_code"></strong> — <span id="applied_discount"></span></span>
                        <button type="button" id="remove_coupon" class="btn-small" style="margin-left:8px">Remove</button>
                    </div>
                </div>

                <label class="checkbox"><input type="checkbox" required> I agree to Terms & Conditions</label>

                <button class="btn-primary">Proceed to Payment</button>
            </form>
        </div>
    </div>

</div>

<script>
(function(){
    const applyBtn = document.getElementById('apply_coupon');
    const input = document.getElementById('coupon_input');
    const msg = document.getElementById('coupon_message');
    const totalEl = document.querySelector('.price-breakdown .row.total span:last-child');
    const totalHidden = document.querySelector('input[name="total"]');
    const spinner = document.getElementById('coupon_spinner');
    const appliedBox = document.getElementById('applied_coupon');
    const appliedCodeEl = document.getElementById('applied_code');
    const appliedDiscountEl = document.getElementById('applied_discount');
    const removeBtn = document.getElementById('remove_coupon');

    const originalTotal = totalHidden.value;

    function setMessage(text, err){
        msg.textContent = text;
        msg.style.color = err ? 'crimson' : '#374151';
    }

    function showSpinner(show){
        spinner.style.display = show ? 'inline-block' : 'none';
        applyBtn.disabled = show;
        input.disabled = show;
    }

    function applyCoupon(code){
        showSpinner(true);
        const url = new URL("{% url 'validate_coupon' %}", window.location.origin);
        url.searchParams.set('code', code);
        url.searchParams.set('plan_id', '{{ plan.id }}');
        url.searchParams.set('total', totalHidden.value);

        fetch(url)
            .then(r => r.json().then(j => ({ok: r.ok, status: r.status, json: j})))
            .then(({ok, status, json}) => {
                showSpinner(false);
                if(!ok){
                    if(status === 404) setMessage('Coupon not found or inactive', true);
                    else setMessage('Invalid coupon or total', true);
                    return;
                }
                // update totals and UI
                totalEl.textContent = '₹ ' + json.payable;
                totalHidden.value = json.payable;
                setMessage('Applied: ' + json.code + ' — Discount ₹' + json.discount, false);
                appliedCodeEl.textContent = json.code;
                appliedDiscountEl.textContent = '₹' + json.discount;
                appliedBox.style.display = 'block';
            })
            .catch(err => { showSpinner(false); setMessage('Error validating coupon', true); });
    }

    applyBtn.addEventListener('click', function(){
        const code = input.value.trim();
        if(!code){ setMessage('Enter a coupon code first', true); return; }
        applyCoupon(code);
    });

    removeBtn.addEventListener('click', function(){
        // restore totals and clear coupon
        totalEl.textContent = '₹ ' + originalTotal;
        totalHidden.value = originalTotal;
        input.value = '';
        appliedBox.style.display = 'none';
        setMessage('Coupon removed', false);
    });
})();
</script>

{% endblock %}
